{# ========================================================================== #}
{# :: Variables #}
{# ========================================================================== #}
{% set id = data.commonId ?? "" %}
{% set title = data.commonTitle ?? "" %}
{% set description = data.commonDescription ?? "" %}
{% set features = data.commonFeatures.all() ?? [] %}

{# ========================================================================== #}
{# :: Component #}
{# ========================================================================== #}
<section x-data="{
        visible: false,
        lines: [],
        anchorPos: null,
        computeLines() {
            const ext1 = this.$refs.ext1;
            const ext2 = this.$refs.ext2;
            const tileBg = this.$el.querySelector('.bm-tile-container');
            if (!ext1 || !ext2 || !tileBg) return;

            const tiles = [...tileBg.children];
            const rowMap = new Map();
            tiles.forEach(t => {
                const top = Math.round(t.getBoundingClientRect().top);
                if (!rowMap.has(top)) rowMap.set(top, []);
                rowMap.get(top).push(t);
            });
            const rows = [...rowMap.entries()].sort((a, b) => a[0] - b[0]);

            let anchorEl = this.$el.querySelector('.bm-anchor-fallback');
            if (rows.length >= 2) {
                const row2 = rows[1][1];
                const target = row2[row2.length - 2] || row2[row2.length - 1];
                if (target) anchorEl = target;
            }

            const sr  = this.$el.getBoundingClientRect();
            const ar  = anchorEl.getBoundingClientRect();
            const e1r = ext1.getBoundingClientRect();
            const e2r = ext2.getBoundingClientRect();

            const ac  = { x: ar.left  + ar.width  / 2 - sr.left, y: ar.top  + ar.height  / 2 - sr.top };
            const e1c = { x: e1r.left + e1r.width / 2 - sr.left, y: e1r.top + e1r.height / 2 - sr.top };
            const e2c = { x: e2r.left + e2r.width / 2 - sr.left, y: e2r.top + e2r.height / 2 - sr.top };

            this.anchorPos = ac;
            this.lines = [
                { x1: e1c.x, y1: e1c.y, x2: e2c.x, y2: e2c.y },
                { x1: e1c.x, y1: e1c.y, x2: ac.x,  y2: ac.y  },
                { x1: e2c.x, y1: e2c.y, x2: ac.x,  y2: ac.y  }
            ];
        },
        init() {
            this.$nextTick(() => this.computeLines());
            this.$watch('visible', v => { if (v) setTimeout(() => this.computeLines(), 100); });
            window.addEventListener('resize', () => this.computeLines());
        }
    }"
    x-intersect.once.margin.0px.0px.-100px.0px="visible = true"
    class="bg-primary py-16 md:py-32 relative overflow-hidden"
    id="{{id}}">

    <style>
        @keyframes bm-float {
            0%, 100% { transform: translateY(0px); }
            50%       { transform: translateY(-10px); }
        }
    </style>

    {# SVG lines (overflow:visible to span across the full section) #}
    <svg class="absolute inset-0 w-full h-full pointer-events-none hidden md:block"
         style="overflow: visible; z-index: 40;" fill="none">
        <template x-for="(line, i) in lines" :key="i">
            <line :x1="line.x1" :y1="line.y1" :x2="line.x2" :y2="line.y2"
                  stroke="rgba(255,255,255,0.45)" stroke-width="1.5" stroke-dasharray="5 4"/>
        </template>
    </svg>

    {# Visible anchor logo — repositioned by Alpine to sit over the targeted tile #}
    <div class="absolute pointer-events-none hidden md:block"
         style="z-index: 45; transition: opacity 0.3s;"
         :style="anchorPos ? `left: ${anchorPos.x - 16}px; top: ${anchorPos.y - 16}px; opacity: 1;` : 'opacity: 0;'">
        {% include "/shapes/logo.twig" with { customClass: 'w-8 h-8', customColor: "#fff" } %}
    </div>

    {# External logo 1 — upper-right green area, outside the gradient box #}
    <div x-ref="ext1"
         class="absolute pointer-events-none hidden md:block"
         style="top: 2rem; right: 3rem; z-index: 50; animation: bm-float 4s ease-in-out infinite;">
        {% include "/shapes/logo.twig" with { customClass: 'w-9 h-9', customColor: "#fff" } %}
    </div>

    {# External logo 2 — lower-right green area, outside the gradient box #}
    <div x-ref="ext2"
         class="absolute pointer-events-none hidden md:block"
         style="bottom: 2rem; right: 5rem; z-index: 50; animation: bm-float 5s ease-in-out infinite 1.2s;">
        {% include "/shapes/logo.twig" with { customClass: 'w-6 h-6', customColor: "#fff" } %}
    </div>

    <div class="container mx-auto px-4 lg:px-8 relative">
        {% if title or description %}
            <div class="text-center mb-16 max-w-3xl mx-auto"
                style="opacity: 0; transform: translateY(40px);"
                :style="`opacity: ${visible ? 1 : 0}; transform: translateY(${visible ? 0 : 40}px); transition: opacity 0.5s ease-out, transform 0.5s ease-out;`">
                {% if title %}
                    <h2 class="text-white mb-6">{{ title|striptags|raw }}</h2>
                {% endif %}
                {% if description %}
                    <h5 class="text-white">{{ description|striptags }}</h5>
                {% endif %}
            </div>
        {% endif %}

        {% if features|length %}

            {# Mobile: stacked cards (image + title + description) #}
            <div class="md:hidden space-y-8"
                style="opacity: 0; transform: translateY(40px);"
                :style="`opacity: ${visible ? 1 : 0}; transform: translateY(${visible ? 0 : 40}px); transition: opacity 0.5s 150ms ease-out, transform 0.5s 150ms ease-out;`">
                {% for feature in features %}
                    {% set image = feature.commonAsset.one() ?? null %}
                    <div class="bg-cover bg-center bg-no-repeat rounded p-6 relative overflow-hidden" style="background-image: url('/assets/gradient.png');">
                        <div class="relative">
                            <div class="flex items-center gap-3 flex-wrap mb-3">
                                <h3 class="text-white">{{ feature.commonTitle|striptags }}</h3>
                                {% if feature.commonIsComingSoon ?? false %}
                                    <span class="inline-block px-3 py-1 rounded-full bg-orange-500 text-white text-xs font-semibold uppercase tracking-wide">Coming soon</span>
                                {% endif %}
                            </div>
                            {% if feature.commonDescription ?? null %}
                                <p class="text-white mb-6">{{ feature.commonDescription|striptags }}</p>
                            {% endif %}
                            {% if image %}
                                {% include 'components/image' with {
                                    asset: image,
                                    alt: feature.commonTitle|striptags,
                                    sizes: '100vw',
                                    class: 'w-full rounded',
                                    lazy: true,
                                    widths: [400, 800],
                                } %}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            {# Desktop: autoplay carousel #}
            <div x-data="{
                    active: 0,
                    total: {{ features|length }},
                    autoplay: true,
                    timer: null,
                    startAutoplay() {
                        if (!this.autoplay || this.timer) return;
                        this.timer = setInterval(() => {
                            this.active = (this.active + 1) % this.total;
                        }, 4000);
                    },
                    stopAutoplay() {
                        this.autoplay = false;
                        clearInterval(this.timer);
                        this.timer = null;
                    },
                    init() {
                        const observer = new IntersectionObserver((entries) => {
                            if (entries[0].isIntersecting) {
                                this.startAutoplay();
                                observer.disconnect();
                            }
                        }, { threshold: 0.3 });
                        observer.observe(this.$el);
                    }
                }"
                class="hidden md:flex flex-row items-center"
                style="opacity: 0; transform: translateY(40px);"
                :style="`opacity: ${visible ? 1 : 0}; transform: translateY(${visible ? 0 : 40}px); transition: opacity 0.5s 150ms ease-out, transform 0.5s 150ms ease-out;`">

                {# Left side: clickable features #}
                <div class="w-1/2">
                    <div class="border-t border-white/40">
                        {% for feature in features %}
                            <div
                                @click="stopAutoplay(); active = {{ loop.index0 }}"
                                class="cursor-pointer p-6 py-12 transition-all border-b border-white/40"
                                :class="active === {{ loop.index0 }} ? 'bg-white/10' : 'hover:bg-white/5'"
                            >
                                <div class="flex items-center gap-3 flex-wrap">
                                    <h3 class="text-white">{{ feature.commonTitle|striptags }}</h3>
                                    {% if feature.commonIsComingSoon ?? false %}
                                        <span class="inline-block px-3 py-1 rounded-full bg-orange-500 text-white text-xs font-semibold uppercase tracking-wide">Coming soon</span>
                                    {% endif %}
                                </div>

                                <div x-show="active === {{ loop.index0 }}">
                                    {% if feature.commonDescription ?? null %}
                                        <p class="text-white mt-6">{{ feature.commonDescription|striptags }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                {# Right side: feature image #}
                <div class="w-1/2 bg-cover bg-center bg-no-repeat rounded p-16 relative overflow-hidden" style="background-image: url('/assets/gradient.png');">

                    {# Fallback anchor (used before tile rows are detected) #}
                    <div class="bm-anchor-fallback absolute pointer-events-none" style="top: 32%; left: 22%;"></div>

                    {# Tile background — each logo wrapped in .bm-tile for row detection #}
                    <div class="bm-tile-container absolute inset-0 overflow-hidden pointer-events-none opacity-10 flex flex-wrap content-start gap-8 p-6">
                        {% for i in 1..2000 %}
                            <div class="bm-tile w-2 h-2 shrink-0">
                                {% include "/shapes/logo.twig" with { customClass: 'w-full h-full', customColor: "#fff" } %}
                            </div>
                        {% endfor %}
                    </div>

                    {% for feature in features %}
                        {% set image = feature.commonAsset.one() ?? null %}
                        {% if image %}
                            <div x-show="active === {{ loop.index0 }}" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="relative">
                                {% include 'components/image' with {
                                    asset: image,
                                    alt: feature.commonTitle|striptags,
                                    sizes: '50vw',
                                    class: 'w-full rounded',
                                    lazy: false,
                                    widths: [400, 800, 1200],
                                } %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</section>
